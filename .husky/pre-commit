#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Prevent committing environment files (but allow .env.example)
if git diff --cached --name-only |
  grep -E '(^|/)\.env(\..*)?$|^client/\.env(\..*)?$' |
  grep -v -E '(^|/)\.env\.example$|^client/\.env\.example$' >/dev/null; then
  echo "\n[HUSKY] Blocked commit: .env files must not be committed."
  echo "Add secrets to your local .env and ensure they are in .gitignore."
  echo "Note: .env.example is allowed."
  exit 1
fi

# Scan staged changes for possible secrets
if git diff --cached -U0 | grep -Ei '(GMAIL_REFRESH_TOKEN|GOOGLE_OAUTH|CLIENT_SECRET|CLIENT-SECRET|refresh_token|api_key|API_KEY|BEGIN RSA PRIVATE KEY|BEGIN PRIVATE KEY|AKIA[0-9A-Z]{16})' >/dev/null; then
  echo "\n[HUSKY] Blocked commit: possible secret detected in staged changes."
  echo "Remove the secret and use environment variables instead."
  exit 1
fi

# Optional: lint (non-blocking if lint not installed)
if command -v npm >/dev/null 2>&1; then
  npm run -s lint >/dev/null 2>&1 || true
fi

exit 0
